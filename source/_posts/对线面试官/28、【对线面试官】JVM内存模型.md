---
title: 28、【对线面试官】JVM内存模型
tags:
  - 面试
  - 记录
categories: 技术
abbrlink: 6f64b3a6
date: 2022-02-28 19:57:47
---
# 28、【对线面试官】JVM内存模型
## 聊聊JVM的内存结构吧？

- class文件会被类加载器装载至JVM中，并且JVM会负责程序「运行时」的「内存管理」
- 而JVM的内存结构，往往指的就是JVM定义的「运行时数据区域」
- 简单来说就分为了5大块：方法区、堆、程序计数器、虚拟机栈、本地方法栈

![](https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/VHXC3i_20211229151038.png)

## 顺便讲下你这图上每个区域的内容

- 程序计数器
  - Java是多线程的语言，假设线程数大于CPU数，就很会有「线程切換」现象，切换意昧着「中断」和「恢复」，那自然就需要有一块区域来保存「当前线程的执行信息」
  - 所以，程序计数器就是用于记录各个线程执行的字节码的地址（分支、循环跳转、异常、线程恢复等都依赖于计数器）
- 虚拟机栈
  - 每个线程在创建的时候都会创建一个虚拟机栈，每次方法调用都会创建一个「栈帧」。每个「栈帧」会包含几块内容：局部变量表、操作数栈、动态连接和返回地址
  - 作用：它保存方法的局部变量、部分变量的计算并参与了方法的调用和返回。

![](https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/GOLAU2_20211229151640.png)

- 本地方法栈
  - 本地方法栈跟虚拟机栈的功能类似，虚拟机栈用于管理Java函数的调用，而本地方法栈则用于管理本地方法的调用。这里的「本地方法」指的是「非Java方法」，一般本地方法是使用C语言实现的。
  
- 方法区
  - 前面提到了运行时数据区这个「分区」是JVM的「规范」，具体的落地实现，不同的虚拟机厂商可能是不一样的
  - 所以「方法区」也只是JVM中规范的一部分
  -  Hotspot虚拟机，就会常常提到「永久代」这个词。 Hotspotl虚拟机在「JDK8前」用「永久代」实现了「方法区」，而很多其他厂商的虚拟机其实是没有「永久代」的概念的
  - 在JDK8中，已经用「元空间」来替代了「永久代」作为「方法区」的实现了
  - 方法区主要是用来存放已被虚拟机加载的「类相关信息」：包括类信息、常量池
    - 类信息又包括了类的版本、字段、方法、接口和父类等信息。
    - 常量池又可以分「静态常量池」和「运行时常量池」
      - 静态常量池主要存储的是「字面量」以及「符号引用」等信息，静态常量池也包括了我们说的「字符串常量池」。
      - 「运行时常量池」存储的是「类加载」时生成的「直接引用」等信息
      - 值得注意的是：从「逻辑分区」的角度而言「常量池」是属于「方法区」的
      - 但自从在「JDK7」以后，就已经把「运行时常量池」和「静态常量池」转移到了「堆」内存中进行存储
      - 对于「物理分区」来说「运行时常量池」和「静态常量池』就属于堆
    - 总体来说，就是逻辑分区和物理实际存储的位置，是不一样的
  
- 堆
  - 「堆」是线程共享的区域，几乎类的实例和数组分配的内存都来自于它
  
  - 「堆」被划分为「新生代」和「老年代」，「新生代」又被进一步划分为Eden和 Survivor区，最后 Survivor由From Survivor 和 To Survivor组成
  

![](https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/Xm317A_20211229152833.png)

## 从「JDK8」已经把「方法区」的实现从「永久代」变成「元空间」，有什么区别？

- 最主要的区别就是：「元空间」存储不在虚拟机中，而是使用本地内存，JVM不会再出现方法区的内存溢出，以往「永久代」经常因为内存不够用导致跑出OOM异常。
- 按JDK8版本，总结起来其实就相当于：「类信息」是存储在「元空间」的（也有人把「类信息」这块叫做「类信息常量池」）
- 而「常量池」用JDK7开始，从「物理存储」角度上就在「堆中」，这是没有变化的。

![](https://cdn.jsdelivr.net/gh/swimminghao/picture@main/img/5Ha0EV_20211229152636.png)

## JVM内存结构和Java內存模型有啥区别吧？

- Java内存模型是跟「并发」相关的，它是为了屏蔽底层细节而提出的规范，希望在上层（Java层面上）在操作内存时在不同的平台上也有相同的效果
- JVM内存结构（又称为运行时数据区域），它描述着当我们的 class文件加载至虚拟机后，各个分区的「逻辑结构」是如何的，每个分区承担的作用

## 总结

**JVM内存结构组成**：JVM内存结构又称为「运行时数据区域」。主要有五部分组成：虚拟机栈、本地方法栈、程序计数器、方法区和堆。其中方法区和堆是线程共享的。虚拟机栈、本地方法栈以及程序计数器是线程隔离的。